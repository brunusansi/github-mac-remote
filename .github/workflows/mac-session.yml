name: ðŸŽ Start Mac Session

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration (hours)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
      runner_size:
        description: 'Runner size (standard=Free/Pro, large/xlarge=Team/Enterprise)'
        required: true
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'large'
          - 'xlarge'
      tunnel_type:
        description: 'Tunnel provider'
        required: true
        default: 'cloudflared'
        type: choice
        options:
          - 'cloudflared'
          - 'ngrok'

env:
  SESSION_DURATION: ${{ github.event.inputs.duration }}
  TUNNEL_TYPE: ${{ github.event.inputs.tunnel_type }}

jobs:
  mac-session:
    name: ðŸ–¥ï¸ Mac Remote Session
    runs-on: ${{ github.event.inputs.runner_size == 'xlarge' && 'macos-14-xlarge' || github.event.inputs.runner_size == 'large' && 'macos-14-large' || 'macos-14' }}
    timeout-minutes: 370
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Display System Information
        run: |
          chmod +x scripts/system-info.sh
          ./scripts/system-info.sh

      - name: ðŸ” Setup VNC (Screen Sharing)
        id: vnc
        run: |
          chmod +x scripts/setup-vnc.sh
          
          # Generate password
          VNC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          echo "VNC_PASSWORD=${VNC_PASSWORD}" >> $GITHUB_ENV
          
          # Export and run
          export VNC_PASSWORD
          ./scripts/setup-vnc.sh

      - name: ðŸš‡ Setup Tunnel
        id: tunnel
        run: |
          chmod +x scripts/setup-tunnel.sh
          
          # Run tunnel setup (this starts tunnel in background)
          export TUNNEL_TYPE="${{ env.TUNNEL_TYPE }}"
          export VNC_PORT=5900
          ./scripts/setup-tunnel.sh
          
          # Give tunnel time to establish
          sleep 10
          
          # Capture tunnel URLs for display
          if [ -f /tmp/tunnel_vnc.log ]; then
            VNC_URL=$(grep -o 'https://[^[:space:]]*\.trycloudflare\.com' /tmp/tunnel_vnc.log | head -1 || grep -o 'tcp://[^[:space:]]*' /tmp/tunnel_vnc.log | head -1 || echo "See logs")
            echo "VNC_TUNNEL_URL=${VNC_URL}" >> $GITHUB_ENV
          fi
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: ðŸ“‹ Save Credentials (Private Artifact)
        run: |
          # Save credentials to a file for private download
          mkdir -p credentials
          cat > credentials/connection-info.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              ðŸŽ GITHUB MAC REMOTE - CONNECTION INFO              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ–¥ï¸  VNC Credentials:
             User: $(whoami)
             Password: ${{ env.VNC_PASSWORD }}
          
          ðŸŒ Tunnel URL: ${{ env.VNC_TUNNEL_URL }}
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          ðŸ“– How to Connect:
          
          1. Install cloudflared on your local machine
          2. Run: cloudflared access tcp --hostname ${{ env.VNC_TUNNEL_URL }} --url localhost:5900
          3. Open VNC client and connect to: localhost:5900
          4. Use the password above
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF

      - name: ðŸ“¦ Upload Credentials Artifact
        uses: actions/upload-artifact@v4
        with:
          name: connection-credentials
          path: credentials/
          retention-days: 1

      - name: ðŸ“‹ Display Public Instructions
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ðŸŽ GITHUB MAC REMOTE - READY TO CONNECT             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ” CREDENTIALS ARE PRIVATE!"
          echo ""
          echo "   Para ver as credenciais de conexÃ£o:"
          echo "   1. VÃ¡ na aba 'Summary' deste workflow"
          echo "   2. Baixe o artifact 'connection-credentials'"
          echo "   3. Abra o arquivo connection-info.txt"
          echo ""
          echo "ðŸŒ Tunnel URL: ${{ env.VNC_TUNNEL_URL }}"
          echo ""
          echo "ðŸ“– Como conectar:"
          echo ""
          echo "   cloudflared access tcp --hostname ${{ env.VNC_TUNNEL_URL }} --url localhost:5900"
          echo ""
          echo "   Depois conecte seu cliente VNC em localhost:5900"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: â±ï¸ Keep Session Alive
        run: |
          chmod +x scripts/keep-alive.sh
          
          export DURATION_HOURS="${{ env.SESSION_DURATION }}"
          ./scripts/keep-alive.sh
