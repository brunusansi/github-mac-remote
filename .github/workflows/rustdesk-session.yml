name: ðŸ¦€ RustDesk Mac Session

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration (hours)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
      runner_size:
        description: 'Runner size (standard=Free/Pro, large/xlarge=Team/Enterprise)'
        required: true
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'large'
          - 'xlarge'

env:
  SESSION_DURATION: ${{ github.event.inputs.duration }}

jobs:
  mac-rustdesk-session:
    name: ðŸ¦€ Mac RustDesk Session
    runs-on: ${{ github.event.inputs.runner_size == 'xlarge' && 'macos-14-xlarge' || github.event.inputs.runner_size == 'large' && 'macos-14-large' || 'macos-14' }}
    timeout-minutes: 370
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Set macOS User Password
        run: |
          # Get current username (runner) and admin username (usually Anka)
          CURRENT_USER=$(whoami)
          echo "CURRENT_USER=${CURRENT_USER}" >> $GITHUB_ENV
          
          # Find the admin user (usually "anka" on GitHub Actions macOS VMs)
          ADMIN_USER=$(dscl . -list /Users | grep -i anka | head -1 || echo "")
          
          if [ -z "$ADMIN_USER" ]; then
            ADMIN_USER=$(dscl . -read /Groups/admin GroupMembership 2>/dev/null | tr ' ' '\n' | grep -v "^GroupMembership:" | grep -v "^root$" | grep -v "^$CURRENT_USER$" | head -1 || echo "")
          fi
          
          if [ -z "$ADMIN_USER" ]; then
            ADMIN_USER="$CURRENT_USER"
          fi
          
          echo "MAC_USER=${ADMIN_USER}" >> $GITHUB_ENV
          echo "ðŸ‘¤ Current user: ${CURRENT_USER}"
          echo "ðŸ‘‘ Admin user: ${ADMIN_USER}"
          
          # Generate a secure password
          MAC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          
          # Mask password in logs
          echo "::add-mask::${MAC_PASSWORD}"
          echo "MAC_PASSWORD=${MAC_PASSWORD}" >> $GITHUB_ENV
          
          echo "ðŸ” Attempting to set password for admin user (${ADMIN_USER})..."
          
          # Known default passwords for Anka VMs
          KNOWN_PASSWORDS=("admin" "anka" "" "password" "123456")
          PASSWORD_SET=false
          
          for OLD_PASS in "${KNOWN_PASSWORDS[@]}"; do
            if [ "$PASSWORD_SET" = false ]; then
              # Try sysadminctl with known old password
              if sudo sysadminctl -resetPasswordFor "${ADMIN_USER}" -newPassword "${MAC_PASSWORD}" -adminUser "${ADMIN_USER}" -adminPassword "${OLD_PASS}" 2>/dev/null; then
                echo "âœ… Password set via sysadminctl (old password found)"
                PASSWORD_SET=true
              # Try dscl with known old password
              elif sudo dscl . -passwd /Users/${ADMIN_USER} "${OLD_PASS}" "${MAC_PASSWORD}" 2>/dev/null; then
                echo "âœ… Password set via dscl (old password: '${OLD_PASS:-empty}')"
                PASSWORD_SET=true
              fi
            fi
          done
          
          # If no known password worked, try without old password
          if [ "$PASSWORD_SET" = false ]; then
            if sudo sysadminctl -resetPasswordFor "${ADMIN_USER}" -newPassword "${MAC_PASSWORD}" 2>/dev/null; then
              echo "âœ… Password set via sysadminctl (no old password needed)"
              PASSWORD_SET=true
            fi
          fi
          
          if [ "$PASSWORD_SET" = false ]; then
            echo ""
            echo "âš ï¸  Could not change the admin password automatically."
            echo "   The admin user may have an unknown pre-existing password."
            echo ""
            echo "   Common default passwords to try manually:"
            echo "   - admin"
            echo "   - anka"
            echo "   - (empty/no password)"
            echo ""
            # Still save the generated password for documentation
            echo "   Generated password saved in artifact for reference."
          fi
          
          echo ""
          echo "   Admin user for System Settings: ${ADMIN_USER}"

      - name: ðŸ“Š System Information
        run: |
          chmod +x scripts/system-info.sh
          ./scripts/system-info.sh

      - name: ðŸŽ® Install Parsec (for optional manual use)
        run: |
          chmod +x scripts/install-parsec.sh
          ./scripts/install-parsec.sh

      - name: ðŸ¦€ Setup RustDesk
        id: rustdesk
        run: |
          chmod +x scripts/setup-rustdesk.sh
          
          # Generate secure password
          RUSTDESK_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          
          # Mask password in GitHub Actions logs
          echo "::add-mask::${RUSTDESK_PASSWORD}"
          
          # Save as environment variable (masked)
          echo "RUSTDESK_PASSWORD=${RUSTDESK_PASSWORD}" >> $GITHUB_ENV
          
          # Export and run
          export RUSTDESK_PASSWORD
          ./scripts/setup-rustdesk.sh
          
          # Wait for RustDesk to register with relay servers
          sleep 10

      - name: ðŸ”‘ Get RustDesk ID
        id: get_id
        run: |
          # Wait for full initialization
          sleep 5
          
          RUSTDESK_CLI="/Applications/RustDesk.app/Contents/MacOS/rustdesk"
          
          if [ -f "$RUSTDESK_CLI" ]; then
            # Try to get ID
            RUSTDESK_ID=$("$RUSTDESK_CLI" --get-id 2>/dev/null || echo "")
            
            if [ -z "$RUSTDESK_ID" ]; then
              # Try from config file
              CONFIG_DIR="$HOME/Library/Application Support/RustDesk"
              RUSTDESK_ID=$(cat "${CONFIG_DIR}/id" 2>/dev/null || echo "")
            fi
            
            if [ -n "$RUSTDESK_ID" ]; then
              echo "RUSTDESK_ID=${RUSTDESK_ID}" >> $GITHUB_ENV
              echo "âœ… RustDesk ID: ${RUSTDESK_ID}"
            else
              echo "âš ï¸ Could not retrieve RustDesk ID automatically"
              echo "RUSTDESK_ID=Check_Logs" >> $GITHUB_ENV
            fi
          fi

      - name: ðŸ’¾ Save Credentials (Private File)
        run: |
          mkdir -p credentials
          
          # Create file with ALL credentials (NOT displayed in logs)
          cat > credentials/connection-info.txt << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    GITHUB MAC REMOTE - CREDENTIALS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Started by: ${{ github.actor }}
          Date/Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Run ID: ${{ github.run_id }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸ¦€ RustDesk Credentials (use these to connect):
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            ID:       ${{ env.RUSTDESK_ID }}
            Password: ${{ env.RUSTDESK_PASSWORD }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸŽ macOS Admin Credentials:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            Admin User: ${{ env.MAC_USER }}
            
            If password was changed successfully:
              Password: ${{ env.MAC_PASSWORD }}
            
            If password change failed, try these default passwords:
              â€¢ admin
              â€¢ anka  
              â€¢ (empty - just press Enter)
          
            Use admin credentials for:
            â€¢ System Settings authentication
            â€¢ Privacy & Security permissions (Input Monitoring, etc.)
            â€¢ Installing apps that require admin
            â€¢ Parsec permissions setup
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸ“– How to Connect:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          1. Download RustDesk from: https://rustdesk.com/download
          2. Install and open RustDesk on your computer
          3. Enter the RustDesk ID shown above
          4. Enter the RustDesk password shown above
          5. Click Connect!
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸŽ® Optional: Parsec is also installed!
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          If you prefer Parsec for lower latency:
          1. Connect via RustDesk first
          2. Open Parsec from Applications
          3. Log in with your Parsec account
          4. When prompted for permissions, use macOS password above
          5. Enable hosting and connect from your other device
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš ï¸  WARNING: This file contains sensitive credentials.
              Do not share with others.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: ðŸ“¦ Upload Credentials Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name includes the user who started it for identification
          name: credentials-${{ github.actor }}-${{ github.run_id }}
          path: credentials/
          retention-days: 1

      - name: ðŸ“‹ Connection Instructions
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ðŸ¦€ GITHUB MAC REMOTE - READY                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ‘¤ Session started by: ${{ github.actor }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ macOS User: ${{ env.MAC_USER }}"
          echo "ðŸ” macOS Password: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (in artifact)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ”‘ RustDesk ID: ${{ env.RUSTDESK_ID }}"
          echo "ðŸ” RustDesk Password: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (in artifact)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“¥ HOW TO GET ALL PASSWORDS:"
          echo ""
          echo "   1. Go to the 'Summary' tab of this workflow"
          echo "   2. Download artifact: credentials-${{ github.actor }}-${{ github.run_id }}"
          echo "   3. Open the connection-info.txt file"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“– How to connect:"
          echo ""
          echo "   1. Download RustDesk: https://rustdesk.com/download"
          echo "   2. Open RustDesk and enter ID: ${{ env.RUSTDESK_ID }}"
          echo "   3. Enter the RustDesk password from the artifact"
          echo "   4. Click Connect!"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸŽ® Parsec is also installed! Use macOS password for permissions."
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â±ï¸  Session active for ${{ env.SESSION_DURATION }} hour(s)"
          echo ""
          echo "ðŸ”’ SECURITY: Passwords are NOT displayed in logs."
          echo "   Only you can download the artifact with credentials."
          echo ""

      - name: â±ï¸ Keep Session Alive
        run: |
          chmod +x scripts/keep-alive.sh
          
          export DURATION_HOURS="${{ env.SESSION_DURATION }}"
          ./scripts/keep-alive.sh
