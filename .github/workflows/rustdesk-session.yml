name: ðŸ¦€ RustDesk Mac Session

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration (hours)'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
      runner_size:
        description: 'Runner size (standard=Free/Pro, large/xlarge=Team/Enterprise)'
        required: true
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'large'
          - 'xlarge'

env:
  SESSION_DURATION: ${{ github.event.inputs.duration }}

jobs:
  mac-rustdesk-session:
    name: ðŸ¦€ Mac RustDesk Session
    runs-on: ${{ github.event.inputs.runner_size == 'xlarge' && 'macos-14-xlarge' || github.event.inputs.runner_size == 'large' && 'macos-14-large' || 'macos-14' }}
    timeout-minutes: 370
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Create Admin User for GUI Authentication
        run: |
          # Create a new admin user that will appear in Users & Groups
          ADMIN_USER="yourname"
          echo "MAC_USER=${ADMIN_USER}" >> $GITHUB_ENV
          
          # Generate a secure password
          MAC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          
          # Mask password in logs
          echo "::add-mask::${MAC_PASSWORD}"
          echo "MAC_PASSWORD=${MAC_PASSWORD}" >> $GITHUB_ENV
          
          echo "ðŸ‘¤ Creating admin user: ${ADMIN_USER}"
          
          # Check if user already exists
          if id "${ADMIN_USER}" &>/dev/null; then
            echo "User ${ADMIN_USER} already exists, setting password..."
            sudo dscl . -passwd /Users/${ADMIN_USER} "" "${MAC_PASSWORD}" 2>/dev/null || \
            sudo sysadminctl -resetPasswordFor "${ADMIN_USER}" -newPassword "${MAC_PASSWORD}" 2>/dev/null || true
          else
            # Find a free UID (starting from 501 for regular users)
            LAST_UID=$(dscl . -list /Users UniqueID | awk '{print $2}' | sort -n | tail -1)
            NEW_UID=$((LAST_UID + 1))
            
            echo "   Creating user with UID: ${NEW_UID}"
            
            # Create the user
            sudo dscl . -create /Users/${ADMIN_USER}
            sudo dscl . -create /Users/${ADMIN_USER} UserShell /bin/zsh
            sudo dscl . -create /Users/${ADMIN_USER} RealName "Your Name"
            sudo dscl . -create /Users/${ADMIN_USER} UniqueID ${NEW_UID}
            sudo dscl . -create /Users/${ADMIN_USER} PrimaryGroupID 20
            sudo dscl . -create /Users/${ADMIN_USER} NFSHomeDirectory /Users/${ADMIN_USER}
            
            # Set password
            sudo dscl . -passwd /Users/${ADMIN_USER} "${MAC_PASSWORD}"
            
            # Add to admin group
            sudo dseditgroup -o edit -a ${ADMIN_USER} -t user admin
            
            # Create home directory
            sudo createhomedir -c -u ${ADMIN_USER} 2>/dev/null || sudo mkdir -p /Users/${ADMIN_USER}
            sudo chown -R ${ADMIN_USER}:staff /Users/${ADMIN_USER} 2>/dev/null || true
          fi
          
          # Verify user was created and is admin
          if id "${ADMIN_USER}" &>/dev/null; then
            echo "âœ… User ${ADMIN_USER} created successfully"
            if dseditgroup -o checkmember -m "${ADMIN_USER}" admin 2>/dev/null; then
              echo "âœ… User ${ADMIN_USER} is an admin"
            fi
          else
            echo "âŒ Failed to create user"
          fi
          
          echo ""
          echo "   Use these credentials for System Settings:"
          echo "   User: ${ADMIN_USER}"
          echo "   Password: (in artifact file)"

      - name: ðŸ“Š System Information
        run: |
          chmod +x scripts/system-info.sh
          ./scripts/system-info.sh

      - name: ðŸŽ® Install Parsec (for optional manual use)
        run: |
          chmod +x scripts/install-parsec.sh
          ./scripts/install-parsec.sh

      - name: ðŸ¦€ Setup RustDesk
        id: rustdesk
        run: |
          chmod +x scripts/setup-rustdesk.sh
          
          # Generate secure password
          RUSTDESK_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          
          # Mask password in GitHub Actions logs
          echo "::add-mask::${RUSTDESK_PASSWORD}"
          
          # Save as environment variable (masked)
          echo "RUSTDESK_PASSWORD=${RUSTDESK_PASSWORD}" >> $GITHUB_ENV
          
          # Export and run
          export RUSTDESK_PASSWORD
          ./scripts/setup-rustdesk.sh
          
          # Wait for RustDesk to register with relay servers
          sleep 10

      - name: ðŸ”‘ Get RustDesk ID
        id: get_id
        run: |
          # Wait for full initialization
          sleep 5
          
          RUSTDESK_CLI="/Applications/RustDesk.app/Contents/MacOS/rustdesk"
          
          if [ -f "$RUSTDESK_CLI" ]; then
            # Try to get ID
            RUSTDESK_ID=$("$RUSTDESK_CLI" --get-id 2>/dev/null || echo "")
            
            if [ -z "$RUSTDESK_ID" ]; then
              # Try from config file
              CONFIG_DIR="$HOME/Library/Application Support/RustDesk"
              RUSTDESK_ID=$(cat "${CONFIG_DIR}/id" 2>/dev/null || echo "")
            fi
            
            if [ -n "$RUSTDESK_ID" ]; then
              echo "RUSTDESK_ID=${RUSTDESK_ID}" >> $GITHUB_ENV
              echo "âœ… RustDesk ID: ${RUSTDESK_ID}"
            else
              echo "âš ï¸ Could not retrieve RustDesk ID automatically"
              echo "RUSTDESK_ID=Check_Logs" >> $GITHUB_ENV
            fi
          fi

      - name: ðŸ’¾ Save Credentials (Private File)
        run: |
          mkdir -p credentials
          
          # Create file with ALL credentials (NOT displayed in logs)
          cat > credentials/connection-info.txt << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    GITHUB MAC REMOTE - CREDENTIALS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Started by: ${{ github.actor }}
          Date/Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Run ID: ${{ github.run_id }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸ¦€ RustDesk Credentials (use these to connect):
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            ID:       ${{ env.RUSTDESK_ID }}
            Password: ${{ env.RUSTDESK_PASSWORD }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸŽ macOS Admin Credentials:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            User:     ${{ env.MAC_USER }}
            Password: ${{ env.MAC_PASSWORD }}
          
            Use these credentials for:
            â€¢ System Settings authentication
            â€¢ Privacy & Security permissions (Input Monitoring, etc.)
            â€¢ Installing apps that require admin
            â€¢ Parsec permissions setup
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸ“– How to Connect:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          1. Download RustDesk from: https://rustdesk.com/download
          2. Install and open RustDesk on your computer
          3. Enter the RustDesk ID shown above
          4. Enter the RustDesk password shown above
          5. Click Connect!
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸŽ® Optional: Parsec is also installed!
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          If you prefer Parsec for lower latency:
          1. Connect via RustDesk first
          2. Open Parsec from Applications
          3. Log in with your Parsec account
          4. When prompted for permissions, use macOS password above
          5. Enable hosting and connect from your other device
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš ï¸  WARNING: This file contains sensitive credentials.
              Do not share with others.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: ðŸ“¦ Upload Credentials Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name includes the user who started it for identification
          name: credentials-${{ github.actor }}-${{ github.run_id }}
          path: credentials/
          retention-days: 1

      - name: ðŸ“‹ Connection Instructions
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ðŸ¦€ GITHUB MAC REMOTE - READY                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ‘¤ Session started by: ${{ github.actor }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ macOS User: ${{ env.MAC_USER }}"
          echo "ðŸ” macOS Password: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (in artifact)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ”‘ RustDesk ID: ${{ env.RUSTDESK_ID }}"
          echo "ðŸ” RustDesk Password: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (in artifact)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“¥ HOW TO GET ALL PASSWORDS:"
          echo ""
          echo "   1. Go to the 'Summary' tab of this workflow"
          echo "   2. Download artifact: credentials-${{ github.actor }}-${{ github.run_id }}"
          echo "   3. Open the connection-info.txt file"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“– How to connect:"
          echo ""
          echo "   1. Download RustDesk: https://rustdesk.com/download"
          echo "   2. Open RustDesk and enter ID: ${{ env.RUSTDESK_ID }}"
          echo "   3. Enter the RustDesk password from the artifact"
          echo "   4. Click Connect!"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸŽ® Parsec is also installed! Use macOS password for permissions."
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â±ï¸  Session active for ${{ env.SESSION_DURATION }} hour(s)"
          echo ""
          echo "ðŸ”’ SECURITY: Passwords are NOT displayed in logs."
          echo "   Only you can download the artifact with credentials."
          echo ""

      - name: â±ï¸ Keep Session Alive
        run: |
          chmod +x scripts/keep-alive.sh
          
          export DURATION_HOURS="${{ env.SESSION_DURATION }}"
          ./scripts/keep-alive.sh
