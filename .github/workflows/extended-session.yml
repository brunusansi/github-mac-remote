name: ðŸ”— Extended Mac Session (Auto-Chain)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration per chain (hours)'
        required: true
        default: '6'
        type: choice
        options:
          - '4'
          - '5'
          - '6'
      max_chains:
        description: 'Maximum number of chains'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      runner_size:
        description: 'Runner size'
        required: true
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'large'
          - 'xlarge'
      current_chain:
        description: 'Current chain number (internal use)'
        required: false
        default: '1'

env:
  SESSION_DURATION: ${{ github.event.inputs.duration }}
  MAX_CHAINS: ${{ github.event.inputs.max_chains }}
  CURRENT_CHAIN: ${{ github.event.inputs.current_chain }}

jobs:
  extended-session:
    name: ðŸ”— Extended Session (Chain ${{ github.event.inputs.current_chain }}/${{ github.event.inputs.max_chains }})
    runs-on: ${{ github.event.inputs.runner_size == 'xlarge' && 'macos-14-xlarge' || github.event.inputs.runner_size == 'large' && 'macos-14-large' || 'macos-14' }}
    timeout-minutes: 375
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Set macOS User Password
        run: |
          # Get current username (runner) and admin username (usually Anka)
          CURRENT_USER=$(whoami)
          echo "CURRENT_USER=${CURRENT_USER}" >> $GITHUB_ENV
          
          # Find the admin user (usually "anka" on GitHub Actions macOS VMs)
          # The admin user is needed for Privacy & Security dialogs
          ADMIN_USER=$(dscl . -list /Users | grep -i anka | head -1 || echo "")
          
          if [ -z "$ADMIN_USER" ]; then
            # If no anka user, try to find an admin user
            ADMIN_USER=$(dscl . -read /Groups/admin GroupMembership 2>/dev/null | tr ' ' '\n' | grep -v "^GroupMembership:" | grep -v "^root$" | grep -v "^$CURRENT_USER$" | head -1 || echo "")
          fi
          
          if [ -z "$ADMIN_USER" ]; then
            ADMIN_USER="$CURRENT_USER"
          fi
          
          echo "MAC_USER=${ADMIN_USER}" >> $GITHUB_ENV
          echo "ðŸ‘¤ Current user: ${CURRENT_USER}"
          echo "ðŸ‘‘ Admin user: ${ADMIN_USER}"
          
          # Generate a secure password
          MAC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          
          # Mask password in logs
          echo "::add-mask::${MAC_PASSWORD}"
          
          # Save to environment
          echo "MAC_PASSWORD=${MAC_PASSWORD}" >> $GITHUB_ENV
          
          echo "ðŸ” Setting password for admin user (${ADMIN_USER})..."
          
          # Try multiple methods to set password for the ADMIN user
          
          # Method 1: Try sysadminctl (works on newer macOS without old password for admin)
          if sudo sysadminctl -resetPasswordFor "${ADMIN_USER}" -newPassword "${MAC_PASSWORD}" 2>/dev/null; then
            echo "âœ… Password set via sysadminctl"
          # Method 2: Try dscl with empty old password (some VMs have no password set)
          elif sudo dscl . -passwd /Users/${ADMIN_USER} "" "${MAC_PASSWORD}" 2>/dev/null; then
            echo "âœ… Password set via dscl (empty old password)"
          # Method 3: Try creating password directly
          elif sudo dscl . -passwd /Users/${ADMIN_USER} "${MAC_PASSWORD}" 2>/dev/null; then
            echo "âœ… Password set via dscl (direct)"
          else
            echo "âš ï¸  Could not set admin password automatically"
            echo "   The admin user may have a pre-existing password"
          fi
          
          echo ""
          echo "   Use this password for:"
          echo "   - System Settings authentication (as ${ADMIN_USER})"
          echo "   - Privacy & Security permissions"
          echo "   - Installing apps that require admin"

      - name: ðŸ“Š System Information
        run: |
          chmod +x scripts/system-info.sh
          ./scripts/system-info.sh
          
          echo ""
          echo "ðŸ”— Chain Information:"
          echo "   â”œâ”€ Current Chain: ${{ env.CURRENT_CHAIN }} / ${{ env.MAX_CHAINS }}"
          echo "   â”œâ”€ Duration: ${{ env.SESSION_DURATION }} hours"
          TOTAL_TIME=$(( ${{ env.CURRENT_CHAIN }} * ${{ env.SESSION_DURATION }} ))
          echo "   â””â”€ Total Time (so far): ${TOTAL_TIME} hours"
          echo ""

      - name: ðŸŽ® Install Parsec (for optional manual use)
        run: |
          chmod +x scripts/install-parsec.sh
          ./scripts/install-parsec.sh

      - name: ðŸ¦€ Setup RustDesk
        run: |
          chmod +x scripts/setup-rustdesk.sh
          
          # Generate secure password
          RUSTDESK_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          
          # Mask password in GitHub Actions logs
          echo "::add-mask::${RUSTDESK_PASSWORD}"
          
          # Save as environment variable (masked)
          echo "RUSTDESK_PASSWORD=${RUSTDESK_PASSWORD}" >> $GITHUB_ENV
          
          export RUSTDESK_PASSWORD
          ./scripts/setup-rustdesk.sh
          
          # Wait for RustDesk to register
          sleep 10

      - name: ðŸ”‘ Get RustDesk ID
        run: |
          sleep 5
          
          RUSTDESK_CLI="/Applications/RustDesk.app/Contents/MacOS/rustdesk"
          
          if [ -f "$RUSTDESK_CLI" ]; then
            RUSTDESK_ID=$("$RUSTDESK_CLI" --get-id 2>/dev/null || echo "")
            
            if [ -z "$RUSTDESK_ID" ]; then
              CONFIG_DIR="$HOME/Library/Application Support/RustDesk"
              RUSTDESK_ID=$(cat "${CONFIG_DIR}/id" 2>/dev/null || echo "")
            fi
            
            if [ -n "$RUSTDESK_ID" ]; then
              echo "RUSTDESK_ID=${RUSTDESK_ID}" >> $GITHUB_ENV
              echo "âœ… RustDesk ID: ${RUSTDESK_ID}"
            else
              echo "RUSTDESK_ID=Check_Logs" >> $GITHUB_ENV
            fi
          fi

      - name: ðŸ’¾ Save Credentials (Private File)
        run: |
          mkdir -p credentials
          
          # Create file with credentials (NOT displayed in logs)
          cat > credentials/connection-info.txt << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            EXTENDED SESSION - Chain ${{ env.CURRENT_CHAIN }}/${{ env.MAX_CHAINS }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Started by: ${{ github.actor }}
          Date/Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Run ID: ${{ github.run_id }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸŽ macOS Credentials:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            User:     ${{ env.MAC_USER }}
            Password: ${{ env.MAC_PASSWORD }}
          
            Use this password for:
            â€¢ System Settings authentication
            â€¢ Privacy & Security permissions (Input Monitoring, etc.)
            â€¢ Installing apps that require admin
            â€¢ Parsec permissions setup
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸ¦€ RustDesk Credentials:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
            ID:       ${{ env.RUSTDESK_ID }}
            Password: ${{ env.RUSTDESK_PASSWORD }}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸ“– How to Connect:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          1. Download RustDesk: https://rustdesk.com/download
          2. Enter the ID and password above
          3. Click Connect!
          
          âš ï¸  New chain = new credentials!
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ðŸŽ® Optional: Parsec is also installed!
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          If you prefer Parsec for lower latency:
          1. Connect via RustDesk first
          2. Open Parsec from Applications
          3. Log in with your Parsec account
          4. When prompted for permissions, use macOS password above
          5. Enable hosting and connect from your other device
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš ï¸  WARNING: This file contains sensitive credentials.
              Do not share with others.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: ðŸ“¦ Upload Credentials Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name includes user and chain for identification
          name: credentials-${{ github.actor }}-chain${{ env.CURRENT_CHAIN }}-${{ github.run_id }}
          path: credentials/
          retention-days: 1

      - name: ðŸ“‹ Connection Instructions
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ðŸ”— EXTENDED SESSION - Chain ${{ env.CURRENT_CHAIN }}/${{ env.MAX_CHAINS }}                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ‘¤ Session started by: ${{ github.actor }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ macOS User: ${{ env.MAC_USER }}"
          echo "ðŸ” macOS Password: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (in artifact)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ”‘ RustDesk ID: ${{ env.RUSTDESK_ID }}"
          echo "ðŸ” RustDesk Password: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (in artifact)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“¥ HOW TO GET ALL PASSWORDS:"
          echo ""
          echo "   1. Go to the 'Summary' tab of this workflow"
          echo "   2. Download artifact: credentials-${{ github.actor }}-chain${{ env.CURRENT_CHAIN }}-${{ github.run_id }}"
          echo "   3. Open the connection-info.txt file"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸŽ® Parsec is also installed! Use macOS password for permissions."
          echo ""
          echo "ðŸ”’ SECURITY: Passwords are NOT displayed in logs."
          echo ""

      - name: â±ï¸ Keep Session Alive (with chain trigger)
        run: |
          chmod +x scripts/keep-alive.sh
          
          DURATION_HOURS=${{ env.SESSION_DURATION }}
          KEEPALIVE_INTERVAL=300
          
          # Calculate times
          DURATION_SECONDS=$((DURATION_HOURS * 3600))
          CHAIN_TRIGGER_TIME=$((DURATION_SECONDS - 120)) # 2 minutes before end
          START_TIME=$(date +%s)
          END_TIME=$((START_TIME + DURATION_SECONDS))
          
          echo "â±ï¸  Keep-alive started"
          echo "   Duration: ${DURATION_HOURS} hour(s)"
          echo "   Next chain trigger: 2 minutes before end"
          echo ""
          
          triggered_chain=false
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((END_TIME - CURRENT_TIME))
            
            if [ $REMAINING -le 0 ]; then
              echo ""
              echo "â° Session time expired."
              break
            fi
            
            # Trigger next chain 2 minutes before end
            if [ $ELAPSED -ge $CHAIN_TRIGGER_TIME ] && [ "$triggered_chain" = false ]; then
              CURRENT_CHAIN=${{ env.CURRENT_CHAIN }}
              MAX_CHAINS=${{ env.MAX_CHAINS }}
              NEXT_CHAIN=$((CURRENT_CHAIN + 1))
              
              if [ $NEXT_CHAIN -le $MAX_CHAINS ]; then
                echo ""
                echo "ðŸ”— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ðŸ”— Starting next chain (${NEXT_CHAIN}/${MAX_CHAINS})..."
                echo "ðŸ”— New session with new credentials coming soon."
                echo "ðŸ”— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                
                # Trigger next workflow
                gh workflow run extended-session.yml \
                  -f duration=${{ env.SESSION_DURATION }} \
                  -f max_chains=${{ env.MAX_CHAINS }} \
                  -f runner_size=${{ github.event.inputs.runner_size }} \
                  -f current_chain=${NEXT_CHAIN}
                
                triggered_chain=true
              else
                echo ""
                echo "âš ï¸  Maximum chains reached. No more extensions."
              fi
            fi
            
            # Warnings
            if [ $REMAINING -le 900 ] && [ $REMAINING -gt 890 ]; then
              echo ""
              echo "âš ï¸  15 minutes remaining in this chain!"
            fi
            
            if [ $REMAINING -le 300 ] && [ $REMAINING -gt 290 ]; then
              echo ""
              echo "ðŸš¨ 5 minutes remaining! Check for new chain credentials."
            fi
            
            # Heartbeat
            HOURS=$((REMAINING / 3600))
            MINUTES=$(((REMAINING % 3600) / 60))
            printf "\rðŸ’“ [%02d:%02d remaining] Chain ${{ env.CURRENT_CHAIN }} active - $(date '+%H:%M:%S')     " $HOURS $MINUTES
            
            SLEEP_TIME=$((REMAINING < KEEPALIVE_INTERVAL ? REMAINING : KEEPALIVE_INTERVAL))
            sleep $SLEEP_TIME
          done
          
          echo ""
          echo "ðŸ‘‹ Chain ${{ env.CURRENT_CHAIN }} ended."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
