name: ðŸŽ Extended Mac Session (Auto-Chain)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration per chain (hours)'
        required: true
        default: '6'
        type: choice
        options:
          - '4'
          - '5'
          - '6'
      max_chains:
        description: 'Maximum number of session chains'
        required: true
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      runner_size:
        description: 'Runner size'
        required: true
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'large'
          - 'xlarge'
      tunnel_type:
        description: 'Tunnel provider'
        required: true
        default: 'cloudflared'
        type: choice
        options:
          - 'cloudflared'
          - 'ngrok'
      current_chain:
        description: 'Current chain number (internal use)'
        required: false
        default: '1'

env:
  SESSION_DURATION: ${{ github.event.inputs.duration }}
  TUNNEL_TYPE: ${{ github.event.inputs.tunnel_type }}
  MAX_CHAINS: ${{ github.event.inputs.max_chains }}
  CURRENT_CHAIN: ${{ github.event.inputs.current_chain }}

jobs:
  extended-session:
    name: ðŸ–¥ï¸ Extended Session (Chain ${{ github.event.inputs.current_chain }}/${{ github.event.inputs.max_chains }})
    runs-on: ${{ github.event.inputs.runner_size == 'xlarge' && 'macos-14-xlarge' || github.event.inputs.runner_size == 'large' && 'macos-14-large' || 'macos-14' }}
    timeout-minutes: 375
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Display System Information
        run: |
          chmod +x scripts/system-info.sh
          ./scripts/system-info.sh
          
          echo ""
          echo "ðŸ”— Chain Info:"
          echo "   â”œâ”€ Current Chain: ${{ env.CURRENT_CHAIN }} / ${{ env.MAX_CHAINS }}"
          echo "   â”œâ”€ Duration: ${{ env.SESSION_DURATION }} hours"
          TOTAL_TIME=$(( ${{ env.CURRENT_CHAIN }} * ${{ env.SESSION_DURATION }} ))
          echo "   â””â”€ Total Time (so far): ${TOTAL_TIME} hours"
          echo ""

      - name: ðŸ” Setup VNC (Screen Sharing)
        run: |
          chmod +x scripts/setup-vnc.sh
          
          VNC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 12)
          echo "VNC_PASSWORD=${VNC_PASSWORD}" >> $GITHUB_ENV
          
          export VNC_PASSWORD
          ./scripts/setup-vnc.sh

      - name: ðŸš‡ Setup Tunnel
        run: |
          chmod +x scripts/setup-tunnel.sh
          
          export TUNNEL_TYPE="${{ env.TUNNEL_TYPE }}"
          export VNC_PORT=5900
          ./scripts/setup-tunnel.sh
          
          sleep 10
          
          if [ -f /tmp/tunnel_vnc.log ]; then
            VNC_URL=$(grep -o 'https://[^[:space:]]*\.trycloudflare\.com' /tmp/tunnel_vnc.log | head -1 || echo "See logs")
            echo "VNC_TUNNEL_URL=${VNC_URL}" >> $GITHUB_ENV
          fi
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: ðŸ“‹ Save Credentials (Private Artifact)
        run: |
          mkdir -p credentials
          cat > credentials/connection-info.txt << EOF
          ðŸŽ EXTENDED SESSION - Chain ${{ env.CURRENT_CHAIN }}/${{ env.MAX_CHAINS }}
          
          VNC User: $(whoami)
          VNC Password: ${{ env.VNC_PASSWORD }}
          Tunnel URL: ${{ env.VNC_TUNNEL_URL }}
          
          Connect: cloudflared access tcp --hostname ${{ env.VNC_TUNNEL_URL }} --url localhost:5900
          Then VNC to: localhost:5900
          EOF

      - name: ðŸ“¦ Upload Credentials Artifact
        uses: actions/upload-artifact@v4
        with:
          name: connection-credentials-chain-${{ env.CURRENT_CHAIN }}
          path: credentials/
          retention-days: 1

      - name: ðŸ“‹ Display Public Instructions
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      ðŸŽ EXTENDED SESSION - Chain ${{ env.CURRENT_CHAIN }}/${{ env.MAX_CHAINS }}                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ” Download 'connection-credentials' artifact for password!"
          echo ""
          echo "ðŸŒ Tunnel URL: ${{ env.VNC_TUNNEL_URL }}"
          echo ""

      - name: â±ï¸ Keep Session Alive (with chain trigger)
        run: |
          chmod +x scripts/keep-alive.sh
          
          DURATION_HOURS=${{ env.SESSION_DURATION }}
          KEEPALIVE_INTERVAL=300
          
          # Calculate times
          DURATION_SECONDS=$((DURATION_HOURS * 3600))
          CHAIN_TRIGGER_TIME=$((DURATION_SECONDS - 120)) # 2 minutes before end
          START_TIME=$(date +%s)
          END_TIME=$((START_TIME + DURATION_SECONDS))
          
          echo "â±ï¸  Session keep-alive started"
          echo "   Duration: ${DURATION_HOURS} hour(s)"
          echo "   Chain trigger: 2 minutes before end"
          echo ""
          
          triggered_chain=false
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((END_TIME - CURRENT_TIME))
            
            if [ $REMAINING -le 0 ]; then
              echo ""
              echo "â° Session time expired."
              break
            fi
            
            # Trigger next chain 2 minutes before end
            if [ $ELAPSED -ge $CHAIN_TRIGGER_TIME ] && [ "$triggered_chain" = false ]; then
              CURRENT_CHAIN=${{ env.CURRENT_CHAIN }}
              MAX_CHAINS=${{ env.MAX_CHAINS }}
              NEXT_CHAIN=$((CURRENT_CHAIN + 1))
              
              if [ $NEXT_CHAIN -le $MAX_CHAINS ]; then
                echo ""
                echo "ðŸ”— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ðŸ”— Triggering next chain (${NEXT_CHAIN}/${MAX_CHAINS})..."
                echo "ðŸ”— New session will start shortly with new credentials."
                echo "ðŸ”— â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                
                # Trigger next workflow
                gh workflow run extended-session.yml \
                  -f duration=${{ env.SESSION_DURATION }} \
                  -f max_chains=${{ env.MAX_CHAINS }} \
                  -f runner_size=${{ github.event.inputs.runner_size }} \
                  -f tunnel_type=${{ env.TUNNEL_TYPE }} \
                  -f current_chain=${NEXT_CHAIN}
                
                triggered_chain=true
              else
                echo ""
                echo "âš ï¸  Maximum chains reached. No more extensions."
              fi
            fi
            
            # Warnings
            if [ $REMAINING -le 900 ] && [ $REMAINING -gt 890 ]; then
              echo ""
              echo "âš ï¸  15 minutes remaining in this chain!"
            fi
            
            if [ $REMAINING -le 300 ] && [ $REMAINING -gt 290 ]; then
              echo ""
              echo "ðŸš¨ 5 minutes remaining! Check for new chain credentials."
            fi
            
            # Heartbeat
            HOURS=$((REMAINING / 3600))
            MINUTES=$(((REMAINING % 3600) / 60))
            printf "\rðŸ’“ [%02d:%02d remaining] Chain ${{ env.CURRENT_CHAIN }} active - $(date '+%H:%M:%S')     " $HOURS $MINUTES
            
            SLEEP_TIME=$((REMAINING < KEEPALIVE_INTERVAL ? REMAINING : KEEPALIVE_INTERVAL))
            sleep $SLEEP_TIME
          done
          
          echo ""
          echo "ðŸ‘‹ Chain ${{ env.CURRENT_CHAIN }} ended."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
